<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="متجر لبيع وشراء المنتجات المستعملة في الجزائر - ابحث عن أفضل الصفقات على الأثاث، الإلكترونيات، الملابس والمزيد">
    <meta name="keywords" content="متجر مستعمل, بيع مستعمل, شراء مستعمل, منتجات مستعملة, أشياء مستعملة, سوق المستعمل">
    <meta name="author" content="متجر المستعمل">
    <meta property="og:title" content="متجر بيع الأشياء المستعملة">
    <meta property="og:description" content="متجر لبيع وشراء المنتجات المستعملة في الجزائر">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ar_SA">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://yourwebsite.com">
    
    <title>متجر بيع الأشياء المستعملة - أفضل الصفقات على المنتجات المستعملة</title>
    
    <!-- تحسين سرعة التحميل -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://nzyjlppvceyjbxzwxccw.supabase.co">
    
    <!-- تحسين إمكانية الوصول -->
    <meta name="theme-color" content="#388E3C">
    <meta name="color-scheme" content="light dark">
    
    <!-- أمان إضافي -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    
    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "متجر بيع الأشياء المستعملة",
        "url": "https://yourwebsite.com",
        "potentialAction": {
            "@type": "SearchAction",
            "target": "https://yourwebsite.com?search={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
    --primary-color: #388E3C; /* أخضر أكثر راحة للعين */
    --primary-dark: #2E7D32;
    --primary-light: #4CAF50;
    --secondary-color: #1976D2; /* أزرق أكثر هدوءاً */
    --danger-color: #E53935; /* أحمر أقل حدة */
    --warning-color: #FFA000; /* لون تحذيري */
    --info-color: #0288D1; /* لون معلومات */
    --text-color: #333333;
    --light-text: #666666;
    --border-color: #E0E0E0;
    --background-light: #FAFAFA;
    --background-dark: #EEEEEE;
    --shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    --border-radius: 8px;
    --container-width: 1200px;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html {
    font-size: 16px;
    scroll-behavior: smooth;
}

body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-light);
            color: var(--text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
/* تحسينات إمكانية الوصول */
a:focus, button:focus, input:focus, select:focus, textarea:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }


a {
    text-decoration: none;
    color: inherit;
}

button {
    cursor: pointer;
    font-family: inherit;
    border: none;
    outline: none;
}

input, select, textarea {
    font-family: inherit;
    font-size: inherit;
}

/* Layout */
.container {
    width: 100%;
    max-width: var(--container-width);
    margin: 0 auto;
    padding: 0 15px;
}

/* Header */
header {
    background-color: var(--primary-color);
    color: white;
    padding: 15px 0;
    box-shadow: var(--shadow);
    position: sticky;
    top: 0;
    z-index: 100;
    transition: all 0.3s ease;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.logo {
    font-weight: bold;
    font-size: 1.5rem;
    flex-grow: 1;
    text-align: center;
    order: 2;
    color: white;
}

.header-buttons {
    display: flex;
    gap: 10px;
    align-items: center;
    order: 3;
    width: 100%;
    justify-content: center;
    margin-top: 10px;
}

.header-buttons button {
    background-color: var(--secondary-color);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: var(--border-radius);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
    transition: var(--transition);
}

.header-buttons button:hover {
    opacity: 0.9;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.header-buttons button.logout {
    background-color: var(--danger-color);
}

.profile-btn-container {
    display: flex;
    align-items: center;
    gap: 10px;
}

.profile-pic {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    object-fit: cover;
    transition: var(--transition);
    background-color: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

.profile-pic:hover {
    transform: scale(1.1);
}

/* Forms */
.form-container {
    max-width: 500px;
    margin: 30px auto;
    padding: 25px;
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.form-title {
    text-align: center;
    color: var(--primary-color);
    margin-bottom: 20px;
    font-size: 1.5rem;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text-color);
}

.form-group input, 
.form-group select, 
.form-group textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    box-sizing: border-box;
    font-family: inherit;
    transition: var(--transition);
    background-color: white;
}

.form-group input:focus, 
.form-group select:focus, 
.form-group textarea:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 2px rgba(56, 142, 60, 0.2);
}

.phone-input {
    display: flex;
}

.phone-prefix {
    padding: 12px;
    background-color: var(--background-dark);
    border: 1px solid var(--border-color);
    border-right: none;
    border-radius: var(--border-radius) 0 0 var(--border-radius);
    display: flex;
    align-items: center;
}

.phone-number {
    flex-grow: 1;
    border-radius: 0 var(--border-radius) var(--border-radius) 0;
}

.form-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
    gap: 15px;
}

/* Buttons */
.btn {
    padding: 12px 20px;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: bold;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 1rem;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.btn:active {
    transform: translateY(0);
    box-shadow: none;
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background-color: var(--primary-dark);
}

.btn-secondary {
    background-color: var(--secondary-color);
    color: white;
}

.btn-secondary:hover {
    opacity: 0.9;
}

.btn-danger {
    background-color: var(--danger-color);
    color: white;
}

.btn-warning {
    background-color: var(--warning-color);
    color: white;
}

.btn-info {
    background-color: var(--info-color);
    color: white;
}

.btn-outline {
    background-color: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-color);
}

.btn-outline:hover {
    background-color: var(--background-light);
}

/* Products Grid */
.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.product-card {
    background-color: white;
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow);
    transition: var(--transition);
    position: relative;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}

.product-image-container {
    position: relative;
    width: 100%;
    height: 200px;
    overflow: hidden;
    cursor: pointer;
    background-color: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
}

.product-card:hover .product-image {
    transform: scale(1.05);
}

.product-info {
    padding: 15px;
}

.product-title {
    font-weight: bold;
    margin-bottom: 5px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    color: var(--text-color);
}

.product-price {
    color: var(--primary-color);
    font-weight: bold;
    margin-bottom: 8px;
    font-size: 1.1rem;
}

.product-phone {
    color: var(--secondary-color);
    margin-bottom: 8px;
    font-size: 0.9rem;
    direction: ltr;
    text-align: left;
}

.product-meta {
    display: flex;
    justify-content: space-between;
    color: var(--light-text);
    font-size: 0.8rem;
    margin-bottom: 8px;
}

.product-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid var(--border-color);
}

.like-btn {
    background: none;
    border: none;
    color: var(--light-text);
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.8rem;
    transition: var(--transition);
}

.like-btn.liked {
    color: var(--danger-color);
}

.like-btn:hover {
    color: var(--danger-color);
}

.views-count {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.8rem;
    color: var(--light-text);
}

/* Profile Page */
.profile-card {
    max-width: 600px;
    margin: 30px auto;
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    padding: 30px;
    animation: fadeIn 0.5s ease;
}

.profile-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    margin-bottom: 30px;
}

.profile-pic-large {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--primary-color);
    transition: var(--transition);
    background-color: var(--background-dark);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--light-text);
    font-size: 48px;
    font-weight: bold;
}

.profile-pic-large:hover {
    transform: scale(1.05);
}

.profile-info {
    text-align: center;
}

.profile-name {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 5px;
    color: var(--text-color);
}

.profile-details {
    margin-top: 20px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-color);
}

.detail-label {
    font-weight: bold;
    color: var(--light-text);
}

.detail-value {
    color: var(--text-color);
}

.profile-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 30px;
    flex-wrap: wrap;
}

/* Image Upload */
.image-upload {
    border: 2px dashed var(--border-color);
    padding: 20px;
    text-align: center;
    margin-bottom: 20px;
    border-radius: var(--border-radius);
    transition: var(--transition);
    background-color: var(--background-light);
}

.image-upload:hover {
    border-color: var(--primary-color);
    background-color: rgba(56, 142, 60, 0.05);
}

.image-preview {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
    justify-content: center;
}

.preview-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 4px;
    transition: var(--transition);
    position: relative;
}

.preview-image:hover {
    transform: scale(1.1);
}

.remove-image {
    position: absolute;
    top: -8px;
    left: -8px;
    background-color: var(--danger-color);
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    cursor: pointer;
    opacity: 0;
    transition: var(--transition);
}

.preview-image:hover .remove-image {
    opacity: 1;
}

/* Modals */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.3s ease;
}

.modal-content {
    background-color: white;
    padding: 25px;
    border-radius: var(--border-radius);
    max-width: 400px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal h2 {
    margin-bottom: 15px;
    color: var(--primary-color);
}

.modal p {
    margin-bottom: 20px;
    color: var(--text-color);
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

/* Image Viewer */
.image-viewer-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.9);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.image-viewer-content {
    position: relative;
    max-width: 90%;
    max-height: 90vh;
}

.image-viewer-img {
    max-width: 100%;
    max-height: 80vh;
    display: block;
    margin: 0 auto;
    border-radius: 4px;
}

.image-viewer-nav {
    position: absolute;
    top: 50%;
    width: 100%;
    display: flex;
    justify-content: space-between;
    transform: translateY(-50%);
}

.image-viewer-nav button {
    background-color: rgba(0,0,0,0.5);
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
    margin: 0 15px;
    transition: var(--transition);
}

.image-viewer-nav button:hover {
    background-color: rgba(0,0,0,0.8);
}

.image-viewer-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background-color: rgba(0,0,0,0.5);
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
    transition: var(--transition);
}

.image-viewer-close:hover {
    background-color: rgba(0,0,0,0.8);
}

.image-viewer-thumbnails {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 15px;
    flex-wrap: wrap;
}

.image-viewer-thumbnail {
    width: 50px;
    height: 50px;
    object-fit: cover;
    cursor: pointer;
    opacity: 0.6;
    transition: var(--transition);
    border: 2px solid transparent;
    border-radius: 4px;
}

.image-viewer-thumbnail:hover, 
.image-viewer-thumbnail.active {
    opacity: 1;
    border-color: white;
}

/* Notifications */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: var(--primary-color);
    color: white;
    padding: 15px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    display: none;
    z-index: 1000;
    animation: slideInRight 0.3s ease;
    max-width: 300px;
}

@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.notification.error {
    background-color: var(--danger-color);
}

.notification.success {
    background-color: var(--primary-color);
}

.notification.warning {
    background-color: var(--warning-color);
}

.notification.info {
    background-color: var(--info-color);
}

.notifications-panel {
    position: fixed;
    top: 70px;
    right: 20px;
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    width: 300px;
    max-height: 400px;
    overflow-y: auto;
    display: none;
    z-index: 999;
    animation: fadeIn 0.3s ease;
}

.notification-item {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    transition: var(--transition);
}

.notification-item:hover {
    background-color: var(--background-light);
}

.notification-item:last-child {
    border-bottom: none;
}

.notification-item strong {
    display: block;
    margin-bottom: 5px;
    color: var(--text-color);
}

.notification-item p {
    font-size: 0.9rem;
    color: var(--light-text);
    margin-bottom: 5px;
}

.notification-item small {
    font-size: 0.7rem;
    color: var(--light-text);
    display: block;
    text-align: left;
}

/* Verification */
.verification-code {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
}

.verification-code input {
    width: 40px;
    height: 50px;
    text-align: center;
    font-size: 20px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    transition: var(--transition);
}

.verification-code input:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 2px rgba(56, 142, 60, 0.2);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--light-text);
    grid-column: 1/-1;
}

.empty-state h3 {
    margin: 10px 0;
    color: var(--text-color);
}

/* Loading Spinner */
.spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Search Bar */
.search-container {
    margin: 20px 0;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.search-input {
    flex-grow: 1;
    min-width: 200px;
    padding: 10px 15px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 1rem;
    transition: var(--transition);
}

.search-input:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 2px rgba(56, 142, 60, 0.2);
}

.search-btn {
    padding: 10px 20px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
}

.search-btn:hover {
    background-color: var(--primary-dark);
}

/* Facebook Login */
.facebook-login-btn {
    background-color: #1877f2;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    margin-top: 15px;
    transition: var(--transition);
}

.facebook-login-btn:hover {
    background-color: #166fe5;
}

/* Responsive Design */
@media (min-width: 768px) {
    .header-buttons {
        order: 3;
        width: auto;
        margin-top: 0;
    }

    .logo {
        order: 1;
        text-align: right;
    }

    .header-content {
        flex-wrap: nowrap;
    }

    .notifications-panel {
        width: 350px;
    }
    
    .profile-actions {
        flex-direction: row;
    }
    
    .btn {
        width: auto;
    }
}

@media (max-width: 767px) {
    html {
        font-size: 15px;
    }
    
    .form-container {
        padding: 20px;
        margin: 20px auto;
    }
    
    .profile-actions {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
    }
    
    .modal-content {
        width: 95%;
        padding: 20px;
    }
    
    .verification-code input {
        width: 35px;
        height: 45px;
        font-size: 18px;
    }
    
    .search-container {
        flex-direction: column;
    }
    
    .search-input, .search-btn {
        width: 100%;
    }
}

@media (max-width: 480px) {
    html {
        font-size: 14px;
    }
    
    .header-content {
        flex-direction: column;
    }
    
    .logo {
        order: 1;
        margin-bottom: 10px;
    }
    
    .header-buttons {
        order: 2;
        justify-content: space-around;
        width: 100%;
    }
    
    .profile-card {
        padding: 20px;
    }
    
    .product-card {
        width: 100%;
    }
    
    .notifications-panel {
        width: 90%;
        right: 5%;
    }
    
    .image-viewer-nav button {
        width: 30px;
        height: 30px;
        font-size: 16px;
        margin: 0 5px;
    }
    
    .image-viewer-close {
        width: 30px;
        height: 30px;
        font-size: 16px;
    }
}
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page" class="container">
        <div class="form-container">
            <h1 class="form-title">تسجيل الدخول</h1>
            <div class="form-group">
                <label for="login-email">البريد الإلكتروني</label>
                <input type="email" id="login-email" placeholder="البريد الإلكتروني">
            </div>
            <div class="form-group">
                <label for="login-password">كلمة المرور</label>
                <input type="password" id="login-password" placeholder="كلمة المرور">
            </div>
            <div class="form-actions">
                <button id="login-btn" class="btn btn-primary">تسجيل الدخول</button>
                <button id="register-btn" class="btn btn-secondary">إنشاء حساب</button>
            </div>
            <p style="text-align: center; margin-top: 15px;">
                <a href="#" id="forgot-password">نسيت كلمة المرور؟</a>
            </p>
            <button id="facebook-login-btn" class="facebook-login-btn">
                <span>تسجيل الدخول عبر فيسبوك</span>
            </button>
        </div>
    </div>

    <!-- OTP Verification Page -->
    <div id="otp-page" class="container" style="display: none;">
        <div class="form-container">
            <h1 class="form-title">التحقق من البريد الإلكتروني</h1>
            <p style="text-align: center; margin-bottom: 20px;">لقد أرسلنا كود التحقق المكون من 6 أرقام إلى بريدك الإلكتروني</p>
            
            <div class="form-group">
                <label for="otp-code">كود التحقق</label>
                <div class="verification-code">
                    <input type="text" id="otp1" maxlength="1" pattern="[0-9]">
                    <input type="text" id="otp2" maxlength="1" pattern="[0-9]">
                    <input type="text" id="otp3" maxlength="1" pattern="[0-9]">
                    <input type="text" id="otp4" maxlength="1" pattern="[0-9]">
                    <input type="text" id="otp5" maxlength="1" pattern="[0-9]">
                    <input type="text" id="otp6" maxlength="1" pattern="[0-9]">
                </div>
            </div>
            
            <div class="form-actions">
                <button id="back-to-login" class="btn btn-secondary">رجوع</button>
                <button id="verify-otp" class="btn btn-primary">تحقق</button>
            </div>
            
            <p style="text-align: center; margin-top: 20px;">
                لم تستلم الكود؟ <a href="#" id="resend-otp" style="color: var(--secondary-color);">إعادة إرسال</a>
            </p>
        </div>
    </div>

    <!-- Register Page -->
    <div id="register-page" class="container" style="display: none;">
        <div class="form-container">
            <h1 class="form-title">إنشاء حساب جديد</h1>
            <div class="form-group">
                <label for="full-name">الاسم الكامل</label>
                <input type="text" id="full-name" placeholder="الاسم الكامل">
            </div>
            <div class="form-group">
                <label for="email">البريد الإلكتروني</label>
                <input type="email" id="email" placeholder="البريد الإلكتروني">
            </div>
            <div class="form-group">
                <label for="password">كلمة المرور</label>
                <input type="password" id="password" placeholder="كلمة المرور">
            </div>
            <div class="form-group">
                <label for="confirm-password">تأكيد كلمة المرور</label>
                <input type="password" id="confirm-password" placeholder="تأكيد كلمة المرور">
            </div>
            <div class="form-group">
                <label for="age">العمر</label>
                <input type="number" id="age" placeholder="العمر" min="16" max="100">
            </div>
            <div class="form-group">
                <label for="wilaya">الولاية</label>
                <select id="wilaya">
                    <option value="">اختر الولاية</option>
                    <option value="أدرار">أدرار</option>
                    <option value="الشلف">الشلف</option>
                    <option value="الأغواط">الأغواط</option>
                    <option value="أم البواقي">أم البواقي</option>
                    <option value="باتنة">باتنة</option>
                    <option value="بجاية">بجاية</option>
                    <option value="بسكرة">بسكرة</option>
                    <option value="بشار">بشار</option>
                    <option value="البليدة">البليدة</option>
                    <option value="البويرة">البويرة</option>
                    <option value="تمنراست">تمنراست</option>
                    <option value="تبسة">تبسة</option>
                    <option value="تلمسان">تلمسان</option>
                    <option value="تيارت">تيارت</option>
                    <option value="تيزي وزو">تيزي وزو</option>
                    <option value="الجزائر">الجزائر</option>
                    <option value="الجلفة">الجلفة</option>
                    <option value="جيجل">جيجل</option>
                    <option value="سطيف">سطيف</option>
                    <option value="سعيدة">سعيدة</option>
                    <option value="سكيكدة">سكيكدة</option>
                    <option value="سيدي بلعباس">سيدي بلعباس</option>
                    <option value="عنابة">عنابة</option>
                    <option value="قالمة">قالمة</option>
                    <option value="قسنطينة">قسنطينة</option>
                    <option value="المدية">المدية</option>
                    <option value="مستغانم">مستغانم</option>
                    <option value="المسيلة">المسيلة</option>
                    <option value="معسكر">معسكر</option>
                    <option value="ورقلة">ورقلة</option>
                    <option value="وهران">وهران</option>
                    <option value="البيض">البيض</option>
                    <option value="إليزي">إليزي</option>
                    <option value="برج بوعريريج">برج بوعريريج</option>
                    <option value="بومرداس">بومرداس</option>
                    <option value="الطارف">الطارف</option>
                    <option value="تندوف">تندوف</option>
                    <option value="تيسمسيلت">تيسمسيلت</option>
                    <option value="الوادي">الوادي</option>
                    <option value="خنشلة">خنشلة</option>
                    <option value="سوق أهراس">سوق أهراس</option>
                    <option value="تيبازة">تيبازة</option>
                    <option value="ميلة">ميلة</option>
                    <option value="عين الدفلى">عين الدفلى</option>
                    <option value="النعامة">النعامة</option>
                    <option value="عين تموشنت">عين تموشنت</option>
                    <option value="غرداية">غرداية</option>
                    <option value="غليزان">غليزان</option>
                    <option value="تيميمون">تيميمون</option>
                    <option value="برج باجي مختار">برج باجي مختار</option>
                    <option value="أولاد جلال">أولاد جلال</option>
                    <option value="بني عباس">بني عباس</option>
                    <option value="عين صالح">عين صالح</option>
                    <option value="عين قزام">عين قزام</option>
                    <option value="تقرت">تقرت</option>
                    <option value="جانت">جانت</option>
                    <option value="المغير">المغير</option>
                    <option value="المنيعة">المنيعة</option>
                </select>
            </div>
            <div class="form-group">
                <label for="register-phone">رقم الهاتف</label>
                <div class="phone-input">
                    <div class="phone-prefix">+213</div>
                    <input type="tel" id="register-phone" class="phone-number" placeholder="رقم الهاتف" inputmode="numeric">
                </div>
            </div>
            <div class="form-actions">
                <button id="back-to-login-from-register" class="btn btn-secondary">رجوع</button>
                <button id="complete-register" class="btn btn-primary">إنشاء الحساب</button>
            </div>
        </div>
    </div>

    <!-- Main Store Page -->
    <div id="store-page" style="display: none;">
        <header>
            <div class="container header-content">
                <div class="logo">متجر بيع الأشياء المستعملة</div>
                <div class="header-buttons">
                    <button id="notifications-btn">
                        <span>الإشعارات</span>
                        <span id="notification-badge" style="display: none; background-color: var(--danger-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; display: flex; align-items: center; justify-content: center;">0</span>
                    </button>
                    
                    <div class="profile-btn-container">
                        <div class="profile-pic" id="header-profile-pic"></div>
                        <button id="profile-btn">
                            <span>الملف الشخصي</span>
                        </button>
                    </div>
                    
                    <button id="logout-btn" class="logout">
                        <span>تسجيل الخروج</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="ابحث عن منتج...">
                <button id="search-btn" class="search-btn">بحث</button>
                <select id="search-category" class="search-input" style="width: 150px;">
                    <option value="">كل الفئات</option>
                    <option value="ملابس">ملابس</option>
                    <option value="أجهزة إلكترونية">أجهزة إلكترونية</option>
                    <option value="أثاث">أثاث</option>
                    <option value="كتب">كتب</option>
                    <option value="أدوات منزلية">أدوات منزلية</option>
                    <option value="أخرى">أخرى</option>
                </select>
            </div>
            <div class="products-grid" id="products-container">
                <!-- المنتجات ستظهر هنا -->
            </div>
        </div>
    </div>

    <!-- Profile Page -->
    <div id="profile-page" style="display: none;">
        <header>
            <div class="container header-content">
                <div class="logo">الملف الشخصي</div>
                <div class="header-buttons">
                    <button id="back-to-store-from-profile" class="btn-secondary">
                        <span>العودة للمتجر</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="profile-card">
                <div class="profile-header">
                    <div class="profile-pic-large" id="profile-picture"></div>
                    <div class="profile-info">
                        <div class="profile-name" id="profile-full-name">الاسم الكامل</div>
                        <div class="profile-email" id="profile-email">البريد الإلكتروني</div>
                    </div>
                </div>
                
                <div class="profile-details">
                    <div class="detail-row">
                        <span class="detail-label">العمر:</span>
                        <span class="detail-value" id="profile-age">30</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">الولاية:</span>
                        <span class="detail-value" id="profile-wilaya">الجزائر</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">رقم الهاتف:</span>
                        <span class="detail-value" id="profile-phone">+213123456789</span>
                    </div>
                </div>
                
                <div class="profile-actions">
                    <button id="change-profile-pic" class="btn btn-secondary">تغيير الصورة</button>
                    <button id="edit-profile" class="btn btn-secondary">تعديل الملف</button>
                    <button id="add-product" class="btn btn-primary">إضافة منتج</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Page -->
    <div id="add-product-page" style="display: none;">
        <header>
            <div class="container header-content">
                <div class="logo">إضافة منتج جديد</div>
                <div class="header-buttons">
                    <button id="back-to-profile" class="btn-secondary">
                        <span>العودة للملف</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="form-container">
                <div class="form-group">
                    <label for="product-name">اسم المنتج</label>
                    <input type="text" id="product-name" placeholder="اسم المنتج">
                </div>
                <div class="form-group">
                    <label for="product-price">السعر (دج)</label>
                    <input type="number" id="product-price" placeholder="السعر بالدينار الجزائري" min="0">
                </div>
                <div class="form-group">
                    <label for="product-category">نوع المنتج</label>
                    <select id="product-category">
                        <option value="">اختر النوع</option>
                        <option value="ملابس">ملابس</option>
                        <option value="أجهزة إلكترونية">أجهزة إلكترونية</option>
                        <option value="أثاث">أثاث</option>
                        <option value="كتب">كتب</option>
                        <option value="أدوات منزلية">أدوات منزلية</option>
                        <option value="أخرى">أخرى</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="product-condition">حالة المنتج</label>
                    <select id="product-condition">
                        <option value="">اختر الحالة</option>
                        <option value="جديد">جديد</option>
                        <option value="ممتاز">ممتاز</option>
                        <option value="جيد">جيد</option>
                        <option value="متوسط">متوسط</option>
                        <option value="سيء">سيء</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="product-description">وصف المنتج</label>
                    <textarea id="product-description" rows="4" placeholder="وصف مفصل عن المنتج"></textarea>
                </div>
                <div class="form-group">
                    <label for="product-phone">رقم الهاتف</label>
                    <div class="phone-input">
                        <div class="phone-prefix">+213</div>
                        <input type="tel" id="product-phone" class="phone-number" placeholder="رقم الهاتف" inputmode="numeric">
                    </div>
                </div>
                <div class="form-group">
                    <label>صور المنتج (1-4 صور)</label>
                    <div class="image-upload">
                        <input type="file" id="product-image-input" accept="image/*" multiple style="display: none;">
                        <button id="upload-images-btn" class="btn btn-secondary">اختر الصور</button>
                        <p style="margin-top: 10px; font-size: 0.8rem; color: var(--light-text);">يمكنك رفع ما يصل إلى 4 صور</p>
                        <div class="image-preview" id="image-preview"></div>
                    </div>
                </div>
                <div class="form-actions">
                    <button id="cancel-add-product" class="btn btn-secondary">إلغاء</button>
                    <button id="publish-product" class="btn btn-primary">نشر المنتج</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Product Modal -->
    <div id="delete-product-modal" class="modal">
        <div class="modal-content">
            <h2>تأكيد حذف المنتج</h2>
            <p>هل أنت متأكد أنك تريد حذف هذا المنتج؟ هذا الإجراء لا يمكن التراجع عنه.</p>
            <div class="modal-actions">
                <button id="cancel-delete-product" class="btn btn-secondary">إلغاء</button>
                <button id="confirm-delete-product" class="btn btn-danger">حذف المنتج</button>
            </div>
        </div>
    </div>

    <!-- Logout Modal -->
    <div id="logout-modal" class="modal">
        <div class="modal-content">
            <h2>تأكيد تسجيل الخروج</h2>
            <p>هل أنت متأكد أنك تريد تسجيل الخروج؟</p>
            <div class="modal-actions">
                <button id="cancel-logout" class="btn btn-secondary">إلغاء</button>
                <button id="confirm-logout" class="btn btn-danger">تسجيل الخروج</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal">
        <div class="modal-content">
            <h2>تعديل الملف الشخصي</h2>
            <div class="form-group">
                <label for="edit-full-name">الاسم الكامل</label>
                <input type="text" id="edit-full-name" placeholder="الاسم الكامل">
            </div>
            <div class="form-group">
                <label for="edit-email">البريد الإلكتروني</label>
                <input type="email" id="edit-email" placeholder="البريد الإلكتروني">
            </div>
            <div class="form-group">
                <label for="edit-age">العمر</label>
                <input type="number" id="edit-age" placeholder="العمر" min="16" max="100">
            </div>
            <div class="form-group">
                <label for="edit-wilaya">الولاية</label>
                <select id="edit-wilaya">
                    <option value="">اختر الولاية</option>
                    <option value="أدرار">أدرار</option>
                    <option value="الشلف">الشلف</option>
                    <option value="الأغواط">الأغواط</option>
                    <option value="أم البواقي">أم البواقي</option>
                    <option value="باتنة">باتنة</option>
                    <option value="بجاية">بجاية</option>
                    <option value="بسكرة">بسكرة</option>
                    <option value="بشار">بشار</option>
                    <option value="البليدة">البليدة</option>
                    <option value="البويرة">البويرة</option>
                    <option value="تمنراست">تمنراست</option>
                    <option value="تبسة">تبسة</option>
                    <option value="تلمسان">تلمسان</option>
                    <option value="تيارت">تيارت</option>
                    <option value="تيزي وزو">تيزي وزو</option>
                    <option value="الجزائر">الجزائر</option>
                    <option value="الجلفة">الجلفة</option>
                    <option value="جيجل">جيجل</option>
                    <option value="سطيف">سطيف</option>
                    <option value="سعيدة">سعيدة</option>
                    <option value="سكيكدة">سكيكدة</option>
                    <option value="سيدي بلعباس">سيدي بلعباس</option>
                    <option value="عنابة">عنابة</option>
                    <option value="قالمة">قالمة</option>
                    <option value="قسنطينة">قسنطينة</option>
                    <option value="المدية">المدية</option>
                    <option value="مستغانم">مستغانم</option>
                    <option value="المسيلة">المسيلة</option>
                    <option value="معسكر">معسكر</option>
                    <option value="ورقلة">ورقلة</option>
                    <option value="وهران">وهران</option>
                    <option value="البيض">البيض</option>
                    <option value="إليزي">إليزي</option>
                    <option value="برج بوعريريج">برج بوعريريج</option>
                    <option value="بومرداس">بومرداس</option>
                    <option value="الطارف">الطارف</option>
                    <option value="تندوف">تندوف</option>
                    <option value="تيسمسيلت">تيسمسيلت</option>
                    <option value="الوادي">الوادي</option>
                    <option value="خنشلة">خنشلة</option>
                    <option value="سوق أهراس">سوق أهراس</option>
                    <option value="تيبازة">تيبازة</option>
                    <option value="ميلة">ميلة</option>
                    <option value="عين الدفلى">عين الدفلى</option>
                    <option value="النعامة">النعامة</option>
                    <option value="عين تموشنت">عين تموشنت</option>
                    <option value="غرداية">غرداية</option>
                    <option value="غليزان">غليزان</option>
                    <option value="تيميمون">تيميمون</option>
                    <option value="برج باجي مختار">برج باجي مختار</option>
                    <option value="أولاد جلال">أولاد جلال</option>
                    <option value="بني عباس">بني عباس</option>
                    <option value="عين صالح">عين صالح</option>
                    <option value="عين قزام">عين قزام</option>
                    <option value="تقرت">تقرت</option>
                    <option value="جانت">جانت</option>
                    <option value="المغير">المغير</option>
                    <option value="المنيعة">المنيعة</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-phone">رقم الهاتف</label>
                <div class="phone-input">
                    <div class="phone-prefix">+213</div>
                    <input type="tel" id="edit-phone" class="phone-number" placeholder="رقم الهاتف" inputmode="numeric">
                </div>
            </div>
            <div class="modal-actions">
                <button id="cancel-edit-profile" class="btn btn-secondary">إلغاء</button>
                <button id="save-profile" class="btn btn-primary">حفظ التغييرات</button>
            </div>
        </div>
    </div>

    <!-- Change Profile Picture Modal -->
    <div id="change-pic-modal" class="modal">
        <div class="modal-content">
            <h2>تغيير صورة الملف الشخصي</h2>
            <div class="image-upload">
                <input type="file" id="new-profile-pic" accept="image/*" style="display: none;">
                <button id="upload-profile-pic-btn" class="btn btn-secondary">اختر صورة</button>
                <div class="image-preview" id="profile-pic-preview"></div>
            </div>
            <div class="modal-actions">
                <button id="cancel-change-pic" class="btn btn-secondary">إلغاء</button>
                <button id="confirm-change-pic" class="btn btn-primary">حفظ الصورة</button>
            </div>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div id="image-viewer-modal" class="image-viewer-modal">
        <div class="image-viewer-content">
            <button class="image-viewer-close">&times;</button>
            <img src="" alt="" class="image-viewer-img" id="viewer-main-image">
            <div class="image-viewer-nav">
                <button id="prev-image">&lt;</button>
                <button id="next-image">&gt;</button>
            </div>
            <div class="image-viewer-thumbnails" id="image-thumbnails"></div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <span id="notification-message"></span>
    </div>

    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notifications-panel">
        <!-- الإشعارات ستظهر هنا -->
    </div>

    <script>
        // تهيئة Supabase مع تحسينات الأمان والأداء
        (function() {
            'use strict';
            
            // تهيئة التطبيق بشكل آمن
            document.addEventListener('DOMContentLoaded', function() {
                // تهيئة Supabase في نطاق محمي
                const initApp = (function() {
                    const supabaseUrl = 'https://nzyjlppvceyjbxzwxccw.supabase.co';
                    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56eWpscHB2Y2V5amJ4end4Y2N3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcyNjI0NDAsImV4cCI6MjA2MjgzODQ0MH0.qFUu115Z-VascH7oC5Ec58EK-2FZnyZfgYPPNJ1HwN8';
                    
                    // التحقق من صحة المفاتيح قبل التهيئة
                    if (!supabaseUrl || !supabaseKey) {
                        console.error('مفاتيح Supabase غير صالحة');
                        return null;
                    }
                    
                    try {
                        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                        
                        // تعطيل الوصول المباشر من وحدة التحكم
                        Object.defineProperty(window, 'supabase', {
                            value: supabase,
                            writable: false,
                            configurable: false
                        });
                        
                        return supabase;
                    } catch (error) {
                        console.error('فشل في تهيئة Supabase:', error);
                        return null;
                    }
                })();
                
                if (!initApp) {
                    document.getElementById('login-page').innerHTML = `
                        <div class="form-container">
                            <h1 class="form-title">خطأ في التهيئة</h1>
                            <p style="text-align: center; color: var(--danger-color);">
                                حدث خطأ في تهيئة التطبيق. يرجى المحاولة لاحقاً.
                            </p>
                        </div>
                    `;
                    return;
                }
                
                // تعريف المتغيرات العامة مع تحسينات الأمان
                const state = {
                    currentUser: null,
                    products: [],
                    notifications: [],
                    currentViewingImages: [],
                    currentImageIndex: 0,
                    otpEmail: '',
                    productToDelete: null,
                    lastSeenProductId: null,
                    notificationChannel: null,
                    isInitialized: false
                };
                
                // تعطيل التعديل على state من وحدة التحكم
                
                // عناصر DOM
                const loginPage = document.getElementById('login-page');
                const otpPage = document.getElementById('otp-page');
                const registerPage = document.getElementById('register-page');
                const storePage = document.getElementById('store-page');
                const profilePage = document.getElementById('profile-page');
                const addProductPage = document.getElementById('add-product-page');
                
                const loginBtn = document.getElementById('login-btn');
                const registerBtn = document.getElementById('register-btn');
                const forgotPasswordBtn = document.getElementById('forgot-password');
                const backToLoginBtn = document.getElementById('back-to-login');
                const backToLoginFromRegisterBtn = document.getElementById('back-to-login-from-register');
                const verifyOtpBtn = document.getElementById('verify-otp');
                const resendOtpBtn = document.getElementById('resend-otp');
                const completeRegisterBtn = document.getElementById('complete-register');
                const facebookLoginBtn = document.getElementById('facebook-login-btn');
                
                const profileBtn = document.getElementById('profile-btn');
                const notificationsBtn = document.getElementById('notifications-btn');
                const notificationBadge = document.getElementById('notification-badge');
                const logoutBtn = document.getElementById('logout-btn');
                const backToStoreFromProfileBtn = document.getElementById('back-to-store-from-profile');
                const backToProfileBtn = document.getElementById('back-to-profile');
                
                const addProductBtn = document.getElementById('add-product');
                const cancelAddProductBtn = document.getElementById('cancel-add-product');
                const publishProductBtn = document.getElementById('publish-product');
                
                const logoutModal = document.getElementById('logout-modal');
                const cancelLogoutBtn = document.getElementById('cancel-logout');
                const confirmLogoutBtn = document.getElementById('confirm-logout');
                
                const deleteProductModal = document.getElementById('delete-product-modal');
                const cancelDeleteProductBtn = document.getElementById('cancel-delete-product');
                const confirmDeleteProductBtn = document.getElementById('confirm-delete-product');
                
                const notification = document.getElementById('notification');
                const notificationMessage = document.getElementById('notification-message');
                
                const productsContainer = document.getElementById('products-container');
                const profilePic = document.getElementById('profile-picture');
                const headerProfilePic = document.getElementById('header-profile-pic');
                const profileFullName = document.getElementById('profile-full-name');
                const profileEmail = document.getElementById('profile-email');
                const profileAge = document.getElementById('profile-age');
                const profileWilaya = document.getElementById('profile-wilaya');
                const profilePhone = document.getElementById('profile-phone');
                
                const uploadImagesBtn = document.getElementById('upload-images-btn');
                const productImageInput = document.getElementById('product-image-input');
                const imagePreview = document.getElementById('image-preview');
    
                // عناصر البحث
                const searchInput = document.getElementById('search-input');
                const searchBtn = document.getElementById('search-btn');
                const searchCategory = document.getElementById('search-category');
    
                // عناصر تعديل الملف الشخصي
                const editProfileBtn = document.getElementById('edit-profile');
                const editProfileModal = document.getElementById('edit-profile-modal');
                const cancelEditProfileBtn = document.getElementById('cancel-edit-profile');
                const saveProfileBtn = document.getElementById('save-profile');
                const editFullName = document.getElementById('edit-full-name');
                const editEmail = document.getElementById('edit-email');
                const editAge = document.getElementById('edit-age');
                const editWilaya = document.getElementById('edit-wilaya');
                const editPhone = document.getElementById('edit-phone');
    
                // عناصر تغيير صورة الملف الشخصي
                const changeProfilePicBtn = document.getElementById('change-profile-pic');
                const changePicModal = document.getElementById('change-pic-modal');
                const cancelChangePicBtn = document.getElementById('cancel-change-pic');
                const confirmChangePicBtn = document.getElementById('confirm-change-pic');
                const newProfilePicInput = document.getElementById('new-profile-pic');
                const uploadProfilePicBtn = document.getElementById('upload-profile-pic-btn');
                const profilePicPreview = document.getElementById('profile-pic-preview');
    
                // عناصر عرض الصور
                const imageViewerModal = document.getElementById('image-viewer-modal');
                const viewerMainImage = document.getElementById('viewer-main-image');
                const imageThumbnails = document.getElementById('image-thumbnails');
                const prevImageBtn = document.getElementById('prev-image');
                const nextImageBtn = document.getElementById('next-image');
                const closeViewerBtn = document.querySelector('.image-viewer-close');
    
                // عناصر التحقق OTP
                const otpInputs = [
                    document.getElementById('otp1'),
                    document.getElementById('otp2'),
                    document.getElementById('otp3'),
                    document.getElementById('otp4'),
                    document.getElementById('otp5'),
                    document.getElementById('otp6')
                ];
    
                // لوحة الإشعارات
                const notificationsPanel = document.getElementById('notifications-panel');
    
                // استماع للأحداث
                document.addEventListener('DOMContentLoaded', initializeApp);
    
                // تحسينات الأمان للوظائف الرئيسية
                const secureFunctions = {
                    handleLogin: async function() {
                        if (state.isInitialized) return;
                        
                        const email = sanitizeInput(document.getElementById('login-email').value);
                        const password = document.getElementById('login-password').value;
                        
                        if (!validateEmail(email) || !validatePassword(password)) {
                            showNotification("بيانات الدخول غير صالحة", "error");
                            return;
                        }
                        
                        try {
                            loginBtn.disabled = true;
                            loginBtn.innerHTML = '<span class="spinner"></span> جاري تسجيل الدخول...';
                            
                            const { data, error } = await supabase.auth.signInWithPassword({
                                email: email,
                                password: password
                            });
                            
                            if (error) throw error;
                            
                            if (data.user) {
                                await loadUserData(data.user.id);
                                await loadProducts();
                                await loadNotifications();
                                showStorePage();
                                showNotification("تم تسجيل الدخول بنجاح", "success");
                            }
                        } catch (error) {
                            console.error("خطأ في تسجيل الدخول:", error);
                            showNotification("خطأ في تسجيل الدخول: " + error.message, "error");
                        } finally {
                            loginBtn.disabled = false;
                            loginBtn.innerHTML = 'تسجيل الدخول';
                        }
                    },
                    
                    sanitizeInput: function(input) {
                        if (typeof input !== 'string') return '';
                        return input.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    },
                    
                    validateEmail: function(email) {
                        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        return re.test(String(email).toLowerCase());
                    },
                    
                    validatePassword: function(password) {
                        return password.length >= 6;
                    },
                    
                    // بقية الوظائف مع تحسينات الأمان
                };
                
                // تهيئة التطبيق
                async function initialize() {
                    try {
                        // التحقق من حالة المصادقة عند التحميل
                        const { data: { session }, error } = await supabase.auth.getSession();
                        
                        if (error) {
                            console.error("خطأ في جلب حالة الجلسة:", error);
                            showLoginPage();
                            return;
                        }
                        
                        if (session?.user) {
                            await loadUserData(session.user.id);
                            await loadProducts();
                            await loadNotifications();
                            setupRealtimeNotifications();
                            showStorePage();
                        } else {
                            showLoginPage();
                        }
                        
                        // الاستماع لتغيرات حالة المصادقة
                        supabase.auth.onAuthStateChange(handleAuthStateChange);
                        
                        state.isInitialized = true;
                    } catch (error) {
                        console.error("خطأ في التهيئة:", error);
                        showNotification("حدث خطأ أثناء تحميل التطبيق", "error");
                    }
                }
                
                // بدء التطبيق
                initialize();
                
                // 1. دوال تهيئة التطبيق
                async function initializeApp() {
                    setupEventListeners();
                    setupOTPInputs();
                }
                
                function setupEventListeners() {
                    // 1. أحداث التنقل بين الصفحات
                    registerBtn.addEventListener('click', () => togglePages(loginPage, registerPage));
                    backToLoginBtn.addEventListener('click', () => togglePages(otpPage, loginPage));
                    backToLoginFromRegisterBtn.addEventListener('click', () => togglePages(registerPage, loginPage));
                    profileBtn.addEventListener('click', showProfilePage);
                    backToStoreFromProfileBtn.addEventListener('click', showStorePage);
                    backToProfileBtn.addEventListener('click', () => togglePages(addProductPage, profilePage));
    
                    // 2. أحداث المصادقة
                    logoutBtn.addEventListener('click', () => showModal(logoutModal));
                    cancelLogoutBtn.addEventListener('click', () => hideModal(logoutModal));
                    confirmLogoutBtn.addEventListener('click', handleLogout);
                    loginBtn.addEventListener('click', secureFunctions.handleLogin);
                    completeRegisterBtn.addEventListener('click', handleRegister);
                    verifyOtpBtn.addEventListener('click', handleVerifyOTP);
                    resendOtpBtn.addEventListener('click', handleResendOTP);
                    forgotPasswordBtn.addEventListener('click', handleForgotPassword);
                    facebookLoginBtn.addEventListener('click', handleFacebookLogin);
    
                    // 3. أحداث المنتجات
                    cancelDeleteProductBtn.addEventListener('click', () => hideModal(deleteProductModal));
                    confirmDeleteProductBtn.addEventListener('click', handleDeleteProduct);
                    addProductBtn.addEventListener('click', showAddProductPage);
                    cancelAddProductBtn.addEventListener('click', cancelAddProduct);
                    publishProductBtn.addEventListener('click', handlePublishProduct);
                    uploadImagesBtn.addEventListener('click', () => productImageInput.click());
                    productImageInput.addEventListener('change', handleImageUpload);
    
                    // 4. أحداث الإشعارات
                    notificationsBtn.addEventListener('click', toggleNotificationsPanel);
                    document.addEventListener('click', handleOutsideNotificationsClick);
    
                    // 5. أحداث الملف الشخصي
                    editProfileBtn.addEventListener('click', setupEditProfileModal);
                    cancelEditProfileBtn.addEventListener('click', () => hideModal(editProfileModal));
                    saveProfileBtn.addEventListener('click', handleSaveProfile);
                    changeProfilePicBtn.addEventListener('click', showChangePicModal);
                    cancelChangePicBtn.addEventListener('click', () => hideModal(changePicModal));
                    uploadProfilePicBtn.addEventListener('click', () => newProfilePicInput.click());
                    newProfilePicInput.addEventListener('change', handleProfilePicUpload);
                    confirmChangePicBtn.addEventListener('click', handleConfirmChangePic);
    
                    // 6. أحداث البحث
                    searchBtn.addEventListener('click', handleSearch);
                    searchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') handleSearch();
                    });
                    searchCategory.addEventListener('change', handleSearch);
    
                    // 7. أحداث عرض الصور
                    closeViewerBtn.addEventListener('click', () => hideModal(imageViewerModal));
                    prevImageBtn.addEventListener('click', showPrevImage);
                    nextImageBtn.addEventListener('click', showNextImage);
                }
    
                // ============= دوال مساعدة =============
    
                function togglePages(hidePage, showPage) {
                    hidePage.style.display = 'none';
                    showPage.style.display = 'block';
                }
    
                function showModal(modal) {
                    modal.style.display = 'flex';
                }
    
                function hideModal(modal) {
                    modal.style.display = 'none';
                }
    
                function showProfilePage() {
                    togglePages(storePage, profilePage);
                    updateProfilePage();
                }
    
                function showStorePage() {
                    [loginPage, otpPage, registerPage, profilePage, addProductPage].forEach(page => {
                        page.style.display = 'none';
                    });
                    storePage.style.display = 'block';
                    renderProducts();
                }
    
                function showAddProductPage() {
                    togglePages(profilePage, addProductPage);
                    if (state.currentUser) {
                        document.getElementById('product-phone').value = state.currentUser.phone.replace('+213', '');
                    }
                }
    
                function cancelAddProduct() {
                    togglePages(addProductPage, profilePage);
                    resetProductForm();
                }
    
                function resetProductForm() {
                    const formFields = [
                        'product-name', 'product-price', 'product-category',
                        'product-condition', 'product-description', 'product-phone'
                    ];
                    
                    formFields.forEach(field => {
                        document.getElementById(field).value = '';
                    });
                    imagePreview.innerHTML = '';
                }
    
                function toggleNotificationsPanel(e) {
                    e.stopPropagation();
                    loadNotifications().then(() => {
                        notificationsPanel.style.display = 
                            notificationsPanel.style.display === 'block' ? 'none' : 'block';
                        markNotificationsAsRead();
                    });
                }
    
                function handleOutsideNotificationsClick(e) {
                    if (!notificationsPanel.contains(e.target) && e.target !== notificationsBtn) {
                        notificationsPanel.style.display = 'none';
                    }
                }
    
                function setupEditProfileModal() {
                    if (!state.currentUser) return;
                    
                    editFullName.value = state.currentUser.full_name;
                    editEmail.value = state.currentUser.email;
                    editAge.value = state.currentUser.age;
                    editWilaya.value = state.currentUser.wilaya;
                    editPhone.value = state.currentUser.phone.replace('+213', '');
                    showModal(editProfileModal);
                }
    
                function showChangePicModal() {
                    if (!state.currentUser) {
                        showNotification("يجب تسجيل الدخول أولاً", "error");
                        return;
                    }
                    profilePicPreview.innerHTML = '';
                    newProfilePicInput.value = '';
                    showModal(changePicModal);
                }
    
                function showPrevImage() {
                    if (state.currentViewingImages.length > 0) {
                        state.currentImageIndex = (state.currentImageIndex - 1 + state.currentViewingImages.length) % state.currentViewingImages.length;
                        updateImageViewer();
                    }
                }
    
                function showNextImage() {
                    if (state.currentViewingImages.length > 0) {
                        state.currentImageIndex = (state.currentImageIndex + 1) % state.currentViewingImages.length;
                        updateImageViewer();
                    }
                }
                        
                function setupOTPInputs() {
                    otpInputs.forEach((input, index) => {
                        input.addEventListener('input', () => {
                            if (input.value.length === 1 && index < otpInputs.length - 1) {
                                otpInputs[index + 1].focus();
                            }
                        });
                        
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Backspace' && input.value.length === 0 && index > 0) {
                                otpInputs[index - 1].focus();
                            }
                        });
                    });
                }
                
                // 2. دوال المصادقة وإدارة المستخدم
                async function handleFacebookLogin() {
                    try {
                        facebookLoginBtn.disabled = true;
                        facebookLoginBtn.innerHTML = '<span class="spinner"></span> جاري تسجيل الدخول...';
                        
                        const { data, error } = await supabase.auth.signInWithOAuth({
                            provider: 'facebook',
                            options: {
                                redirectTo: window.location.href,
                                scopes: 'email',
                            }
                        });
                        
                        if (error) throw error;
                        
                    } catch (error) {
                        console.error("خطأ في تسجيل الدخول عبر فيسبوك:", error);
                        showNotification("خطأ في تسجيل الدخول عبر فيسبوك: " + error.message, "error");
                    } finally {
                        facebookLoginBtn.disabled = false;
                        facebookLoginBtn.innerHTML = 'تسجيل الدخول عبر فيسبوك';
                    }
                }
                
                async function handleRegister() {
                    const fullName = document.getElementById('full-name').value;
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    const confirmPassword = document.getElementById('confirm-password').value;
                    const age = document.getElementById('age').value;
                    const wilaya = document.getElementById('wilaya').value;
                    const phone = document.getElementById('register-phone').value;
                    
                    if (!fullName || !email || !password || !confirmPassword || !age || !wilaya || !phone) {
                        showNotification("الرجاء ملء جميع الحقول المطلوبة", "error");
                        return;
                    }
                    
                    if (password !== confirmPassword) {
                        showNotification("كلمة المرور وتأكيدها غير متطابقين", "error");
                        return;
                    }
                    
                    if (phone.length !== 9) {
                        showNotification("رقم الهاتف يجب أن يتكون من 9 أرقام", "error");
                        return;
                    }
                    
                    try {
                        completeRegisterBtn.disabled = true;
                        completeRegisterBtn.innerHTML = '<span class="spinner"></span> جاري التسجيل...';
                        
                        // 1. إنشاء الحساب مع إرسال بريد تأكيد
                        const { data, error } = await supabase.auth.signUp({
                            email: email,
                            password: password,
                            options: {
                                data: {
                                    full_name: fullName,
                                    age: age,
                                    wilaya: wilaya,
                                    phone: `+213${phone}`
                                }
                            }
                        });
    
                        if (error) throw error;
                        
                        // عرض صفحة OTP
                        state.otpEmail = email;
                        loginPage.style.display = 'none';
                        registerPage.style.display = 'none';
                        otpPage.style.display = 'block';
                        showNotification("تم إرسال كود التحقق إلى بريدك الإلكتروني", "success");
    
                    } catch (error) {
                        console.error("خطأ في التسجيل:", error);
                        showNotification("خطأ في التسجيل: " + error.message, "error");
                    } finally {
                        completeRegisterBtn.disabled = false;
                        completeRegisterBtn.innerHTML = 'إنشاء الحساب';
                    }
                }
                   
                async function handleVerifyOTP() {
                    const otpCode = otpInputs.map(input => input.value).join('');
                    
                    if (otpCode.length !== 6) {
                        showNotification("الرجاء إدخال كود التحقق المكون من 6 أرقام", "error");
                        return;
                    }
                    
                    try {
                        verifyOtpBtn.disabled = true;
                        verifyOtpBtn.innerHTML = '<span class="spinner"></span> جاري التحقق...';
                        
                        // 1. التحقق من OTP
                        const { data, error } = await supabase.auth.verifyOtp({
                            email: state.otpEmail,
                            token: otpCode,
                            type: 'email'
                        });
    
                        if (error) throw error;
                        
                        // 2. الحصول على الجلسة الحالية بعد التحقق
                        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                        
                        if (sessionError || !session) {
                            throw sessionError || new Error("لا توجد جلسة نشطة");
                        }
                        
                        // 3. تحميل بيانات المستخدم
                        await loadUserData(session.user.id);
                        
                        // 4. تحميل المنتجات
                        await loadProducts();
                        
                        // 5. الانتقال إلى المتجر
                        showStorePage();
                        showNotification("تم التحقق بنجاح", "success");
                        
                    } catch (error) {
                        console.error("خطأ في التحقق:", error);
                        showNotification("كود التحقق غير صحيح أو انتهت صلاحيته: " + error.message, "error");
                    } finally {
                        verifyOtpBtn.disabled = false;
                        verifyOtpBtn.innerHTML = 'تحقق';
                    }
                }
             
                async function handleResendOTP() {
                    try {
                        resendOtpBtn.disabled = true;
                        resendOtpBtn.innerHTML = '<span class="spinner"></span> جاري الإرسال...';
                        
                        const { error } = await supabase.auth.resend({
                            type: 'signup',
                            email: state.otpEmail
                        });
                        
                        if (error) throw error;
                        
                        showNotification("تم إعادة إرسال كود التحقق إلى بريدك الإلكتروني", "success");
                    } catch (error) {
                        console.error("خطأ في إعادة إرسال كود التحقق:", error);
                        showNotification("خطأ في إعادة إرسال كود التحقق: " + error.message, "error");
                    } finally {
                        resendOtpBtn.disabled = false;
                        resendOtpBtn.innerHTML = 'إعادة إرسال';
                    }
                }
                
                async function handleForgotPassword() {
                    const email = document.getElementById('login-email').value;
                    
                    if (!email) {
                        showNotification("الرجاء إدخال البريد الإلكتروني", "error");
                        return;
                    }
                    
                    try {
                        forgotPasswordBtn.disabled = true;
                        forgotPasswordBtn.innerHTML = '<span class="spinner"></span> جاري الإرسال...';
                        
                        const { error } = await supabase.auth.resetPasswordForEmail(email);
                        
                        if (error) throw error;
                        
                        showNotification("تم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني", "success");
                    } catch (error) {
                        console.error("خطأ في إرسال رابط إعادة التعيين:", error);
                        showNotification("خطأ في إرسال رابط إعادة التعيين: " + error.message, "error");
                    } finally {
                        forgotPasswordBtn.disabled = false;
                        forgotPasswordBtn.innerHTML = 'نسيت كلمة المرور؟';
                    }
                }
                
                async function handleLogout() {
                    try {
                        confirmLogoutBtn.disabled = true;
                        confirmLogoutBtn.innerHTML = '<span class="spinner"></span> جاري تسجيل الخروج...';
                        
                        // إلغاء الاشتراك في قناة الإشعارات
                        if (state.notificationChannel) {
                            supabase.removeChannel(state.notificationChannel);
                            state.notificationChannel = null;
                        }
                        
                        const { error } = await supabase.auth.signOut();
                        if (error) throw error;
                        
                        logoutModal.style.display = 'none';
                        state.currentUser = null;
                        showLoginPage();
                        showNotification("تم تسجيل الخروج بنجاح", "success");
                    } catch (error) {
                        console.error("خطأ في تسجيل الخروج:", error);
                        showNotification("خطأ في تسجيل الخروج: " + error.message, "error");
                    } finally {
                        confirmLogoutBtn.disabled = false;
                        confirmLogoutBtn.innerHTML = 'تسجيل الخروج';
                    }
                }
                
                async function loadUserData(userId) {
                    try {
                        // 1. جلب بيانات الملف الشخصي
                        const { data: userData, error } = await supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', userId)
                            .maybeSingle();
                        
                        if (error) throw error;
                        
                        if (userData) {
                            // 2. تهيئة liked_products إذا كانت غير موجودة أو غير صالحة
                            state.currentUser = {
                                ...userData,
                                liked_products: Array.isArray(userData.liked_products) ? 
                                    userData.liked_products : []
                            };
                            updateProfilePage();
                        } else {
                            // 3. إنشاء ملف شخصي جديد إذا لم يكن موجوداً
                            const { data: authData } = await supabase.auth.getUser();
                            
                            if (authData.user) {
                                let fullName = authData.user.user_metadata?.full_name || 
                                              authData.user.user_metadata?.name || 
                                              'مستخدم جديد';
                                
                                let profilePic = authData.user.user_metadata?.avatar_url || '';
                                
                                const newProfile = {
                                    id: authData.user.id,
                                    full_name: fullName,
                                    email: authData.user.email,
                                    age: authData.user.user_metadata?.age || 18,
                                    wilaya: authData.user.user_metadata?.wilaya || 'الجزائر',
                                    phone: authData.user.user_metadata?.phone || '+213000000000',
                                    profile_pic: profilePic,
                                    liked_products: []
                                };
    
                                const { data: insertedProfile, error: insertError } = await supabase
                                    .from('profiles')
                                    .insert(newProfile)
                                    .select()
                                    .single();
                                
                                if (insertError) throw insertError;
                                
                                state.currentUser = {
                                    ...insertedProfile,
                                    liked_products: []
                                };
                                updateProfilePage();
                            }
                        }
                    } catch (error) {
                        console.error("خطأ في جلب بيانات المستخدم:", error);
                        showNotification("خطأ في جلب بيانات المستخدم: " + (error.message || "حدث خطأ غير متوقع"), "error");
                        
                        // إنشاء مستخدم مؤقت لتجنب الأخطاء
                        state.currentUser = {
                            id: userId,
                            liked_products: [],
                            full_name: 'مستخدم',
                            email: '',
                            age: 18,
                            wilaya: 'الجزائر',
                            phone: '+213000000000',
                            profile_pic: ''
                        };
                    }
                }
                  
                async function handleAuthStateChange(event, session) {
                    console.log("حدث المصادقة:", event, "جلسة:", session);
                    
                    if (event === 'SIGNED_IN' && session?.user) {
                        try {
                            await loadUserData(session.user.id);
                            await loadProducts();
                            await loadNotifications();
                            setupRealtimeNotifications();
                            showStorePage();
                        } catch (error) {
                            console.error("خطأ في تحميل البيانات:", error);
                            showNotification("حدث خطأ أثناء تحميل البيانات", "error");
                        }
                    } else if (event === 'SIGNED_OUT') {
                        state.currentUser = null;
                        showLoginPage();
                    } else if (event === 'TOKEN_REFRESHED') {
                        console.log("تم تجديد جلسة المستخدم");
                    } else if (event === 'USER_UPDATED') {
                        if (session?.user) {
                            await loadUserData(session.user.id);
                        }
                    }
                }
                
                // 3. دوال إدارة المنتجات
                async function loadProducts() {
                    try {
                        let query = supabase
                            .from('products')
                            .select('*')
                            .order('created_at', { ascending: false });
                        
                        // إذا كان هناك منتج تم مشاهدته آخر مرة، نحمله أولاً
                        if (state.lastSeenProductId) {
                            query = query.eq('id', state.lastSeenProductId);
                        } else {
                            query = query.limit(20);
                        }
                        
                        const { data: productsData, error } = await query;
                        
                        if (error) throw error;
                        
                        const productsWithImages = [];
                        
                        for (const product of productsData) {
                            // زيادة عدد المشاهدات عند تحميل المنتج
                            await increaseProductViews(product.id);
                            
                            const signedUrls = await getSignedProductImageUrls(product.image_paths || []);
                            productsWithImages.push({
                                ...product,
                                signed_image_urls: signedUrls
                            });
                        }
                        
                        state.products = productsWithImages;
                        renderProducts();
                        
                        // إذا كنا قد جلبنا منتجاً واحداً فقط (آخر منتج تم مشاهدته)
                        // نحمّل بقية المنتجات الآن
                        if (state.lastSeenProductId) {
                            state.lastSeenProductId = null;
                            await loadProducts(); // إعادة تحميل جميع المنتجات
                        }
                        
                    } catch (error) {
                        console.error("خطأ في جلب المنتجات:", error);
                        showNotification("خطأ في جلب المنتجات: " + error.message, "error");
                    }
                }
                
                async function increaseProductViews(productId) {
                    try {
                        // لا نزيد المشاهدات إذا كان المستخدم هو صاحب المنتج
                        const product = state.products.find(p => p.id === productId);
                        if (product && state.currentUser && product.user_id === state.currentUser.id) {
                            return;
                        }
                        
                        const { error } = await supabase.rpc('increment_views', {
                            product_id: productId
                        });
                        
                        if (error) throw error;
                        
                    } catch (error) {
                        console.error("خطأ في زيادة المشاهدات:", error);
                    }
                }
                
                async function handleSearch() {
                    const searchTerm = searchInput.value.trim();
                    const category = searchCategory.value;
                    
                    try {
                        let query = supabase
                            .from('products')
                            .select('*')
                            .order('created_at', { ascending: false });
                        
                        if (searchTerm) {
                            query = query
                                .ilike('name', `%${searchTerm}%`)
                                .or(`description.ilike.%${searchTerm}%`);
                        }
                        
                        if (category) {
                            query = query.eq('category', category);
                        }
                        
                        const { data: productsData, error } = await query;
                        
                        if (error) throw error;
                        
                        const productsWithImages = [];
                        
                        for (const product of productsData) {
                            const signedUrls = await getSignedProductImageUrls(product.image_paths || []);
                            productsWithImages.push({
                                ...product,
                                signed_image_urls: signedUrls
                            });
                        }
                        
                        state.products = productsWithImages;
                        renderProducts();
                        
                    } catch (error) {
                        console.error("خطأ في البحث:", error);
                        showNotification("خطأ في البحث: " + error.message, "error");
                    }
                }
    
                function renderProducts() {
                    productsContainer.innerHTML = '';
                    
                    if (state.products.length === 0) {
                        productsContainer.innerHTML = `
                            <div class="empty-state" style="grid-column: 1/-1;">
                                <div>📭</div>
                                <h3>لا توجد منتجات متاحة حالياً</h3>
                                <p>كن أول من ينشر منتج في المتجر</p>
                            </div>
                        `;
                        return;
                    }
                    
                    state.products.forEach(product => {
                        const productCard = document.createElement('div');
                        productCard.className = 'product-card';
                        
                        const isLiked = state.currentUser && state.currentUser.liked_products && state.currentUser.liked_products.includes(product.id);
                        
                        const imageUrl = (product.signed_image_urls && product.signed_image_urls.length > 0)
                            ? product.signed_image_urls[0]
                            : null;
                        
                        productCard.innerHTML = `
                            <div class="product-image-container">
                                ${imageUrl ? 
                                    `<img src="${imageUrl}" alt="${product.name}" class="product-image">` :
                                    '<div style="font-size: 48px;">📷</div>'}
                            </div>
                            <div class="product-info">
                                <div class="product-title">${product.name}</div>
                                <div class="product-price">${product.price.toLocaleString()} دج</div>
                                <div class="product-meta">
                                    <span>${product.category}</span>
                                    <span>${product.condition}</span>
                                </div>
                                <div class="product-phone">
                                    <a href="tel:${product.phone}">${product.phone}</a>
                                </div>
                                <div class="product-actions">
                                    <button class="like-btn ${isLiked ? 'liked' : ''}" data-product-id="${product.id}">
                                        <span>${isLiked ? '❤️' : '🤍'}</span>
                                        <span>${product.likes || 0}</span>
                                    </button>
                                    <div class="views-count">
                                        <span>👁️</span>
                                        <span>${product.views || 0}</span>
                                    </div>
                                </div>
                                ${state.currentUser && product.user_id === state.currentUser.id ? 
                                    `<button class="delete-product-btn" data-product-id="${product.id}">حذف المنتج</button>` : ''}
                            </div>
                        `;
                        
                        // عرض الصور في عارض الصور عند النقر
                        const productImage = productCard.querySelector('.product-image-container');
                        productImage.addEventListener('click', async () => {
                            if (product.signed_image_urls && product.signed_image_urls.length > 0) {
                                // حفظ آخر منتج تمت مشاهدته
                                state.lastSeenProductId = product.id;
                                openImageViewer(product.signed_image_urls);
                            }
                        });
                        
                        // إعجاب بالمنتج
                        const likeBtn = productCard.querySelector('.like-btn');
                        likeBtn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            await handleLikeProduct(e.target.closest('.like-btn'));
                        });
                        
                        // حذف المنتج
                        if (state.currentUser && product.user_id === state.currentUser.id) {
                            const deleteBtn = productCard.querySelector('.delete-product-btn');
                            deleteBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                state.productToDelete = product.id;
                                deleteProductModal.style.display = 'flex';
                            });
                        }
                        
                        productsContainer.appendChild(productCard);
                    });
                }
                
                async function handleLikeProduct(likeBtn) {
                    const productId = likeBtn.dataset.productId;
                    const product = state.products.find(p => p.id === productId);
                    
                    if (!state.currentUser) {
                        showNotification("يجب تسجيل الدخول للإعجاب بالمنتجات", "error");
                        return;
                    }
                    
                    try {
                        const isLiked = likeBtn.classList.contains('liked');
                        
                        if (!state.currentUser.liked_products) {
                            state.currentUser.liked_products = [];
                        }
                        
                        if (isLiked) {
                            // إزالة الإعجاب
                            const { error: productError } = await supabase
                                .from('products')
                                .update({ 
                                    likes: Math.max((product.likes || 0) - 1, 0)
                                })
                                .eq('id', productId);
                            
                            if (productError) throw productError;
                            
                            const updatedLikes = state.currentUser.liked_products.filter(id => id !== productId);
                            
                            const { error: profileError } = await supabase
                                .from('profiles')
                                .update({
                                    liked_products: updatedLikes
                                })
                                .eq('id', state.currentUser.id);
                            
                            if (profileError) throw profileError;
                            
                            likeBtn.classList.remove('liked');
                            likeBtn.innerHTML = `<span>🤍</span><span>${Math.max((product.likes || 1) - 1, 0)}</span>`;
                            state.currentUser.liked_products = updatedLikes;
                            product.likes = Math.max((product.likes || 1) - 1, 0);
                            showNotification("تمت إزالة الإعجاب", "success");
                        } else {
                            // إضافة إعجاب
                            const { error: productError } = await supabase
                                .from('products')
                                .update({ 
                                    likes: (product.likes || 0) + 1 
                                })
                                .eq('id', productId);
                            
                            if (productError) throw productError;
                            
                            const newLikes = [...state.currentUser.liked_products, productId];
                            
                            const { error: profileError } = await supabase
                                .from('profiles')
                                .update({
                                    liked_products: newLikes
                                })
                                .eq('id', state.currentUser.id);
                            
                            if (profileError) throw profileError;
    
                            if (product.user_id !== state.currentUser.id) {
                                const productOwner = await getProfileById(product.user_id);
                                
                                if (productOwner) { // التحقق من وجود المستخدم قبل إرسال الإشعار
                                    const message = `❤️ ${state.currentUser.full_name} أعجب بمنتجك "${product.name}"`;
                                    
                                    const { error } = await supabase.from('notifications').insert({
                                        user_id: product.user_id,
                                        message: message,
                                        related_product_id: product.id,
                                        created_at: new Date().toISOString(),
                                        read: false // تأكد من وجود هذا الحقل في جدولك
                                    });
                                    
                                    if (error) throw error;
                                }
                            }
                            
                            likeBtn.classList.add('liked');
                            likeBtn.innerHTML = `<span>❤️</span><span>${(product.likes || 0) + 1}</span>`;
                            state.currentUser.liked_products = newLikes;
                            product.likes = (product.likes || 0) + 1;
                            showNotification("تمت إضافة الإعجاب", "success");
                        }
                    } catch (error) {
                        console.error("خطأ في تحديث الإعجاب:", error);
                        showNotification("خطأ في تحديث الإعجاب: " + (error.message || "حدث خطأ غير متوقع"), "error");
                        
                        // إعادة تحميل حالة الإعجاب الحقيقية من السيرفر
                        await loadUserData(state.currentUser.id);
                        await loadProducts();
                    }
                }
    
                async function getProfileById(userId) {
                    try {
                        const { data, error } = await supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', userId)
                            .maybeSingle(); // هذا سيحل مشكلة عدم وجود بيانات
                        
                        if (error) throw error;
                        return data;
                    } catch (error) {
                        console.error("خطأ في جلب بيانات المستخدم:", error);
                        return null;
                    }
                }
    
                async function setupRealtimeNotifications() {
                    if (!state.currentUser || state.notificationChannel) return;
                    
                    // إلغاء أي اشتراك سابق
                    if (state.notificationChannel) {
                        supabase.removeChannel(state.notificationChannel);
                    }
                    
                    // إنشاء اشتراك جديد
                    state.notificationChannel = supabase
                        .channel('notifications-channel')
                        .on(
                            'postgres_changes',
                            {
                                event: 'INSERT',
                                schema: 'public',
                                table: 'notifications',
                                filter: `user_id=eq.${state.currentUser.id}`
                            },
                            async (payload) => {
                                const newNotification = payload.new;
                                console.log('إشعار جديد:', newNotification);
                                
                                // عرض إشعار فوري
                                showNotification(newNotification.message, "info");
                                
                                // تحديث عدد الإشعارات غير المقروءة
                                await loadNotifications();
                            }
                        )
                        .subscribe();
                }
                
                async function loadNotifications() {
                    if (!state.currentUser) return;
                    
                    try {
                        const { data: notificationsData, error } = await supabase
                            .from('notifications')
                            .select('*')
                            .eq('user_id', state.currentUser.id)
                            .order('created_at', { ascending: false })
                            .limit(10);
                            
                        if (error) throw error;
                        
                        state.notifications = notificationsData || [];
                        renderNotifications();
                        updateNotificationBadge();
                        
                    } catch (error) {
                        console.error("خطأ في جلب الإشعارات:", error);
                    }
                }     
               
                async function handlePublishProduct() {
                    let imagePaths = [];
    
                    try {
                        if (!state.currentUser) {
                            showNotification("يجب تسجيل الدخول أولاً", "error");
                            return;
                        }
    
                        const productName = document.getElementById('product-name').value.trim();
                        const productPrice = document.getElementById('product-price').value.trim();
                        const productCategory = document.getElementById('product-category').value;
                        const productCondition = document.getElementById('product-condition').value;
                        const productDescription = document.getElementById('product-description').value.trim();
                        const productPhone = document.getElementById('product-phone').value.trim();
                        const files = productImageInput.files;
    
                        if (!files || files.length === 0 || files.length > 4) {
                            showNotification("يجب اختيار من 1 إلى 4 صور للمنتج", "error");
                            return;
                        }
    
                        if (!productName || !productPrice || !productCategory || !productCondition || !productPhone) {
                            showNotification("الرجاء تعبئة جميع الحقول المطلوبة", "error");
                            return;
                        }
    
                        publishProductBtn.disabled = true;
                        publishProductBtn.innerHTML = '<span class="spinner"></span> جاري النشر...';
    
                        // رفع الصور إلى التخزين
                        for (let file of files) {
                            const ext = file.name.split('.').pop();
                            const fileName = `${state.currentUser.id}_${Date.now()}_${Math.floor(Math.random() * 10000)}.${ext}`;
                            const filePath = `product-images/${fileName}`;
    
                            const { error: uploadError } = await supabase.storage
                                .from('product-images')
                                .upload(filePath, file, {
                                    cacheControl: '3600',
                                    contentType: file.type,
                                    upsert: false
                                });
    
                            if (uploadError) throw uploadError;
                            imagePaths.push(filePath);
                        }
    
                        // إدراج المنتج في قاعدة البيانات
                        const { data, error: insertError } = await supabase
                            .from('products')
                            .insert([{
                                user_id: state.currentUser.id,
                                name: productName,
                                price: parseFloat(productPrice),
                                category: productCategory,
                                condition: productCondition,
                                description: productDescription,
                                phone: `+213${productPhone}`,
                                image_paths: imagePaths,
                                created_at: new Date().toISOString(),
                                views: 0,
                                likes: 0
                            }])
                            .select();
    
                        if (insertError) throw insertError;
    
                        // إرسال إشعارات لجميع المستخدمين الآخرين
                        await sendNewProductNotification(productName, data[0].id);
    
                        showNotification("تم نشر المنتج بنجاح", "success");
                        resetProductForm();
                        await loadProducts();
                        showStorePage();
    
                    } catch (error) {
                        console.error("خطأ في نشر المنتج:", error);
    
                        // حذف الصور التي تم رفعها في حالة حدوث خطأ
                        if (imagePaths.length > 0) {
                            await supabase.storage
                                .from('product-images')
                                .remove(imagePaths)
                                .catch(console.error);
                        }
    
                        showNotification("خطأ في نشر المنتج: " + (error.message || "تأكد من صحة البيانات"), "error");
                    } finally {
                        publishProductBtn.disabled = false;
                        publishProductBtn.innerHTML = 'نشر المنتج';
                    }
                }
    
                async function sendNewProductNotification(productName, productId) {
                    try {
                        // جلب جميع المستخدمين عدا المستخدم الحالي
                        const { data: users, error } = await supabase
                            .from('profiles')
                            .select('id')
                            .neq('id', state.currentUser.id);
                        
                        if (error) throw error;
                        
                        if (users && users.length > 0) {
                            // إنشاء إشعار لكل مستخدم
                            const notifications = users.map(user => ({
                                user_id: user.id,
                                message: `📦 ${state.currentUser.full_name} نشر منتج جديد: "${productName}"`,
                                related_product_id: productId,
                                created_at: new Date().toISOString()
                            }));
                            
                            // إدراج الإشعارات في قاعدة البيانات
                            const { error: insertError } = await supabase
                                .from('notifications')
                                .insert(notifications);
                            
                            if (insertError) throw insertError;
                        }
                        
                    } catch (error) {
                        console.error("خطأ في إرسال الإشعارات:", error);
                    }
                }
                
                async function getSignedProductImageUrls(imagePaths) {
                    const urls = [];
                    
                    for (const path of imagePaths) {
                        const { data, error } = await supabase.storage
                            .from('product-images')
                            .createSignedUrl(path, 60 * 60); // صالح لمدة ساعة
                        
                        if (!error && data) {
                            urls.push(data.signedUrl);
                        } else {
                            console.error('فشل في توليد رابط الصورة:', path, error);
                        }
                    }
                    
                    return urls;
                }
                
                async function handleDeleteProduct() {
                    if (!state.productToDelete || !state.currentUser) {
                        return;
                    }
    
                    try {
                        confirmDeleteProductBtn.disabled = true;
                        confirmDeleteProductBtn.innerHTML = '<span class="spinner"></span> جاري الحذف...';
    
                        // 1. حذف الصور من التخزين
                        const product = state.products.find(p => p.id === state.productToDelete);
                        if (product && product.image_paths && product.image_paths.length > 0) {
                            const { error: deleteImagesError } = await supabase.storage
                                .from('product-images')
                                .remove(product.image_paths);
    
                            if (deleteImagesError) throw deleteImagesError;
                        }
    
                        // 2. حذف المنتج من قاعدة البيانات
                        const { error: deleteError } = await supabase
                            .from('products')
                            .delete()
                            .eq('id', state.productToDelete);
    
                        if (deleteError) throw deleteError;
    
                        // 3. تحديث القائمة المحلية
                        state.products = state.products.filter(p => p.id !== state.productToDelete);
                        renderProducts();
    
                        deleteProductModal.style.display = 'none';
                        showNotification("تم حذف المنتج بنجاح", "success");
                        state.productToDelete = null;
    
                    } catch (error) {
                        console.error("خطأ في حذف المنتج:", error);
                        showNotification("خطأ في حذف المنتج: " + error.message, "error");
                    } finally {
                        confirmDeleteProductBtn.disabled = false;
                        confirmDeleteProductBtn.innerHTML = 'حذف المنتج';
                    }
                }
                
                // 4. دوال إدارة الصور
                function handleImageUpload(e) {
                    imagePreview.innerHTML = '';
                    const files = e.target.files;
                    
                    if (files.length > 4) {
                        showNotification("يمكنك رفع 4 صور كحد أقصى", "error");
                        return;
                    }
                    
                    for (let i = 0; i < Math.min(files.length, 4); i++) {
                        const file = files[i];
                        const reader = new FileReader();
                        
                        reader.onload = (event) => {
                            const imgContainer = document.createElement('div');
                            imgContainer.style.position = 'relative';
                            
                            const img = document.createElement('img');
                            img.src = event.target.result;
                            img.classList.add('preview-image');
                            
                            const removeBtn = document.createElement('span');
                            removeBtn.classList.add('remove-image');
                            removeBtn.innerHTML = '&times;';
                            removeBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                imgContainer.remove();
                                
                                // إنشاء قائمة جديدة من الملفات بدون الملف المحذوف
                                const newFiles = Array.from(productImageInput.files).filter((_, idx) => idx !== i);
                                
                                // إنشاء DataTransfer جديد وإضافة الملفات المتبقية
                                const dataTransfer = new DataTransfer();
                                newFiles.forEach(file => dataTransfer.items.add(file));
                                
                                // تعيين الملفات الجديدة لعنصر الإدخال
                                productImageInput.files = dataTransfer.files;
                            });
                            
                            imgContainer.appendChild(img);
                            imgContainer.appendChild(removeBtn);
                            imagePreview.appendChild(imgContainer);
                        };
                        
                        reader.readAsDataURL(file);
                    }
                }
                
                function handleProfilePicUpload(e) {
                    profilePicPreview.innerHTML = '';
                    const file = e.target.files[0];
                    
                    if (file) {
                        const reader = new FileReader();
                        
                        reader.onload = (event) => {
                            const img = document.createElement('img');
                            img.src = event.target.result;
                            img.classList.add('preview-image');
                            profilePicPreview.appendChild(img);
                        };
                        
                        reader.readAsDataURL(file);
                    }
                }
                
                async function handleConfirmChangePic() {
                    const file = newProfilePicInput.files[0];
                    if (!file || !state.currentUser) return;
    
                    try {
                        confirmChangePicBtn.disabled = true;
                        confirmChangePicBtn.innerHTML = '<span class="spinner"></span> جاري الحفظ...';
    
                        // 1. إعداد اسم فريد للملف
                        const fileExt = file.name.split('.').pop();
                        const fileName = `${state.currentUser.id}_${Date.now()}.${fileExt}`;
                        const filePath = fileName;
    
                        // 2. رفع الصورة إلى bucket
                        const { error: uploadError } = await supabase.storage
                            .from('profile-pictures')
                            .upload(filePath, file, {
                                cacheControl: '3600',
                                contentType: file.type,
                                upsert: true
                            });
    
                        if (uploadError) throw uploadError;
    
                        // 3. توليد رابط مؤقت للعرض (Signed URL)
                        const { data: signedUrlData, error: signedUrlError } = await supabase.storage
                            .from('profile-pictures')
                            .createSignedUrl(filePath, 60 * 60);
    
                        if (signedUrlError) throw signedUrlError;
    
                        const signedUrl = signedUrlData.signedUrl;
    
                        // 4. حفظ اسم الملف فقط في قاعدة البيانات
                        const { error: updateError } = await supabase
                            .from('profiles')
                            .update({ profile_pic: filePath })
                            .eq('id', state.currentUser.id);
    
                        if (updateError) throw updateError;
    
                        // 5. تحديث البيانات في الواجهة مع الرابط المؤقت
                        state.currentUser.profile_pic = filePath;
                        updateProfilePicElements(signedUrl);
                        changePicModal.style.display = 'none';
                        showNotification("تم تحديث صورة الملف الشخصي بنجاح", "success");
    
                    } catch (error) {
                        console.error("خطأ في تغيير صورة الملف الشخصي:", error);
                        showNotification("خطأ في تغيير صورة الملف الشخصي: " + error.message, "error");
                    } finally {
                        confirmChangePicBtn.disabled = false;
                        confirmChangePicBtn.innerHTML = 'حفظ الصورة';
                    }
                }
                
                function openImageViewer(images) {
                    state.currentViewingImages = images;
                    state.currentImageIndex = 0;
                    
                    viewerMainImage.src = images[0];
                    
                    imageThumbnails.innerHTML = '';
                    images.forEach((img, index) => {
                        const thumb = document.createElement('img');
                        thumb.src = img;
                        thumb.classList.add('image-viewer-thumbnail');
                        if (index === 0) thumb.classList.add('active');
                        
                        thumb.addEventListener('click', () => {
                            state.currentImageIndex = index;
                            updateImageViewer();
                        });
                        
                        imageThumbnails.appendChild(thumb);
                    });
                    
                    imageViewerModal.style.display = 'flex';
                }
                
                function updateImageViewer() {
                    if (state.currentViewingImages.length > 0) {
                        viewerMainImage.src = state.currentViewingImages[state.currentImageIndex];
                        
                        const thumbnails = imageThumbnails.querySelectorAll('.image-viewer-thumbnail');
                        thumbnails.forEach((thumb, index) => {
                            if (index === state.currentImageIndex) {
                                thumb.classList.add('active');
                            } else {
                                thumb.classList.remove('active');
                            }
                        });
                    }
                }
                
                // 5. دوال إدارة الملف الشخصي
                async function updateProfilePage() {
                    if (!state.currentUser) return;
    
                    profileFullName.textContent = state.currentUser.full_name;
                    profileEmail.textContent = state.currentUser.email;
                    profileAge.textContent = state.currentUser.age;
                    profileWilaya.textContent = state.currentUser.wilaya;
                    profilePhone.textContent = state.currentUser.phone;
    
                    // جلب Signed URL لصورة الملف الشخصي إن وجدت
                    if (state.currentUser.profile_pic && state.currentUser.profile_pic.trim() !== '') {
                        try {
                            // إذا كانت الصورة رابط مباشر (مثل فيسبوك)
                            if (state.currentUser.profile_pic.startsWith('http')) {
                                updateProfilePicElements(state.currentUser.profile_pic);
                            } else {
                                // إذا كانت مخزنة في Supabase Storage
                                const { data: signedUrlData, error: signedUrlError } = await supabase.storage
                                    .from('profile-pictures')
                                    .createSignedUrl(state.currentUser.profile_pic, 60 * 60);
    
                                if (signedUrlError) throw signedUrlError;
    
                                updateProfilePicElements(signedUrlData.signedUrl);
                            }
                        } catch (err) {
                            console.error('فشل في تحميل صورة الملف الشخصي:', err);
                            updateProfilePicElements(null);
                        }
                    } else {
                        updateProfilePicElements(null);
                    }
                }
    
                function updateProfilePicElements(url) {
                    const profilePic = document.getElementById('profile-picture');
                    const headerPic = document.getElementById('header-profile-pic');
    
                    // مسح المحتوى الحالي
                    profilePic.innerHTML = '';
                    headerPic.innerHTML = '';
    
                    if (url && url.trim() !== '') {
                        // إنشاء عنصر صورة لعرضها
                        const largeImg = document.createElement('img');
                        largeImg.src = url;
                        largeImg.alt = 'صورة الملف الشخصي';
                        largeImg.onerror = () => {
                            profilePic.textContent = state.currentUser?.full_name?.charAt(0) || 'U';
                        };
    
                        const smallImg = document.createElement('img');
                        smallImg.src = url;
                        smallImg.alt = 'صورة الملف الشخصي المصغرة';
                        smallImg.onerror = () => {
                            headerPic.textContent = state.currentUser?.full_name?.charAt(0) || 'U';
                        };
    
                        // تطبيق الأنماط
                        const imgStyle = {
                            width: '100%',
                            height: '100%',
                            borderRadius: '50%',
                            objectFit: 'cover',
                            display: 'block'
                        };
    
                        Object.assign(largeImg.style, imgStyle);
                        Object.assign(smallImg.style, imgStyle);
    
                        profilePic.appendChild(largeImg);
                        headerPic.appendChild(smallImg);
                    } else {
                        // fallback إلى أول حرف من الاسم
                        const initial = state.currentUser?.full_name?.charAt(0) || 'U';
                        profilePic.textContent = initial;
                        headerPic.textContent = initial;
    
                        // تنسيق
                        profilePic.style.display = 'flex';
                        profilePic.style.alignItems = 'center';
                        profilePic.style.justifyContent = 'center';
                        profilePic.style.fontWeight = 'bold';
                        profilePic.style.fontSize = profilePic.offsetWidth / 2 + 'px';
                        profilePic.style.color = '#666';
                    }
                }
                
                async function handleSaveProfile() {
                    if (!state.currentUser) {
                        showNotification("يجب تسجيل الدخول أولاً", "error");
                        return;
                    }
    
                    const fullName = editFullName.value;
                    const email = editEmail.value;
                    const age = editAge.value;
                    const wilaya = editWilaya.value;
                    const phone = editPhone.value;
                    
                    if (!fullName || !email || !age || !wilaya || !phone) {
                        showNotification("الرجاء ملء جميع الحقول", "error");
                        return;
                    }
                    
                    try {
                        saveProfileBtn.disabled = true;
                        saveProfileBtn.innerHTML = '<span class="spinner"></span> جاري الحفظ...';
                        
                        const { error } = await supabase
                            .from('profiles')
                            .update({
                                full_name: fullName,
                                email,
                                age,
                                wilaya,
                                phone: `+213${phone}`
                            })
                            .eq('id', state.currentUser.id);
                        
                        if (error) throw error;
                        
                        state.currentUser.full_name = fullName;
                        state.currentUser.email = email;
                        state.currentUser.age = age;
                        state.currentUser.wilaya = wilaya;
                        state.currentUser.phone = `+213${phone}`;
                        
                        updateProfilePage();
                        editProfileModal.style.display = 'none';
                        showNotification("تم تحديث الملف الشخصي بنجاح", "success");
                    } catch (error) {
                        console.error("خطأ في تحديث الملف الشخصي:", error);
                        showNotification("خطأ في تحديث الملف الشخصي: " + error.message, "error");
                    } finally {
                        saveProfileBtn.disabled = false;
                        saveProfileBtn.innerHTML = 'حفظ التغييرات';
                    }
                }
                
                // 6. دوال إدارة الإشعارات
                async function markNotificationsAsRead() {
                    if (!state.currentUser || state.notifications.length === 0) return;
                    
                    try {
                        // تحديث الإشعارات الغير مقروءة فقط
                        const unreadIds = state.notifications
                            .filter(n => !n.read)
                            .map(n => n.id);
                        
                        if (unreadIds.length > 0) {
                            const { error } = await supabase
                                .from('notifications')
                                .update({ read: true })
                                .in('id', unreadIds);
                            
                            if (error) throw error;
                            
                            // تحديث القائمة المحلية
                            state.notifications.forEach(n => n.read = true);
                            updateNotificationBadge();
                        }
                        
                    } catch (error) {
                        console.error("خطأ في تحديث حالة الإشعارات:", error);
                    }
                }
                
                function renderNotifications() {
                    notificationsPanel.innerHTML = '';
                    
                    if (state.notifications.length === 0) {
                        const emptyItem = document.createElement('div');
                        emptyItem.className = 'notification-item';
                        emptyItem.innerHTML = '<p>لا توجد إشعارات جديدة</p>';
                        notificationsPanel.appendChild(emptyItem);
                        return;
                    }
                    
                    state.notifications.forEach(notif => {
                        const item = document.createElement('div');
                        item.className = 'notification-item';
                        
                        // تمييز الإشعارات غير المقروءة
                        if (!notif.read) {
                            item.style.backgroundColor = 'rgba(46, 125, 50, 0.1)';
                        }
                        
                        item.innerHTML = `
                            <p>${notif.message}</p>
                            <small>${formatTimeAgo(notif.created_at)}</small>
                        `;
                        
                        // إضافة معالج حدث للنقر على الإشعار
                        if (notif.related_product_id) {
                            item.style.cursor = 'pointer';
                            item.addEventListener('click', async () => {
                                state.lastSeenProductId = notif.related_product_id;
                                await loadProducts();
                                showStorePage();
                                notificationsPanel.style.display = 'none';
                            });
                        }
                        
                        notificationsPanel.appendChild(item);
                    });
                }
    
                function updateNotificationBadge() {
                    const unreadCount = state.notifications.filter(notif => !notif.read).length;
                    if (unreadCount > 0) {
                        notificationBadge.style.display = 'flex';
                        notificationBadge.textContent = unreadCount;
                    } else {
                        notificationBadge.style.display = 'none';
                    }
                }
                
                function showNotification(message, type = "success") {
                    notification.className = `notification ${type}`;
                    notificationMessage.textContent = message;
                    notification.style.display = 'block';
                    
                    setTimeout(() => {
                        notification.style.display = 'none';
                    }, 3000);
                }
                
                // 7. دوال مساعدة
                function formatTimeAgo(dateString) {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffInSeconds = Math.floor((now - date) / 1000);
                    
                    if (diffInSeconds < 60) {
                        return `منذ ${diffInSeconds} ثانية`;
                    }
                    
                    const diffInMinutes = Math.floor(diffInSeconds / 60);
                    if (diffInMinutes < 60) {
                        return `منذ ${diffInMinutes} دقيقة`;
                    }
                    
                    const diffInHours = Math.floor(diffInMinutes / 60);
                    if (diffInHours < 24) {
                        return `منذ ${diffInHours} ساعة`;
                    }
                    
                    const diffInDays = Math.floor(diffInHours / 24);
                    if (diffInDays < 7) {
                        return `منذ ${diffInDays} يوم`;
                    }
                    
                    return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
                }
                
                function showStorePage() {
                    loginPage.style.display = 'none';
                    otpPage.style.display = 'none';
                    registerPage.style.display = 'none';
                    profilePage.style.display = 'none';
                    addProductPage.style.display = 'none';
                    storePage.style.display = 'block';
                    
                    renderProducts();
                    updateProfilePage();
                    renderNotifications();
                    updateNotificationBadge();
                }
                
                function showLoginPage() {
                    loginPage.style.display = 'block';
                    otpPage.style.display = 'none';
                    registerPage.style.display = 'none';
                    storePage.style.display = 'none';
                    profilePage.style.display = 'none';
                    addProductPage.style.display = 'none';
                }
            });
        })();
    </script>
</body>
</html>